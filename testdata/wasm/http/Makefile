.PHONY: all clean tidy

all: tidy main.wasm main.go

tidy:
	@echo "Tidying dependencies..."
	@cd src && go mod tidy

main.wasm: src/main.go src/go.mod
	@echo "Building HTTP test module..."
	@cd src && tinygo build -o ../main.wasm -target wasi .

main.go: main.wasm
	@echo "Generating Go embed file..."
	@echo "// Generated by Makefile - DO NOT EDIT." > main.go
	@echo "package http" >> main.go
	@echo "" >> main.go
	@echo "import \"embed\"" >> main.go
	@echo "import \"io/fs\"" >> main.go
	@echo "" >> main.go
	@echo "//go:embed main.wasm" >> main.go
	@echo "var file embed.FS" >> main.go
	@echo "" >> main.go
	@echo "// Program returns the WASM program" >> main.go
	@echo "func Program() (b []byte) {" >> main.go
	@echo "	b, err := fs.ReadFile(file, \"main.wasm\")" >> main.go
	@echo "	if err != nil {" >> main.go
	@echo "		panic(err)" >> main.go
	@echo "	}" >> main.go
	@echo "	return" >> main.go
	@echo "}" >> main.go

clean:
	@echo "Cleaning build artifacts..."
	@rm -f main.wasm main.go 