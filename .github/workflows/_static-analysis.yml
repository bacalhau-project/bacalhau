name: Static Analysis

on:
  workflow_call:
    inputs:
      go_version_file:
        description: 'Path to the file containing Go version'
        required: false
        default: 'go.work'
        type: string
      golangci_lint_version:
        description: 'Version of golangci-lint to use'
        required: false
        default: 'v1.64.5'
        type: string

jobs:
  analyze:
    name: Static Analysis
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # Setup common tools with caching
      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version-file: ${{ inputs.go_version_file }}
          cache: true

      # Run all static analysis checks
      - name: Codespell
        run: |
          yarn global add cspell@latest
          make spellcheck-code

      # Run swagger validation if enabled
      - name: Validate Swagger
        uses: ./.github/actions/swagger-validation

      # Run pre-commit hooks if enabled
      - name: Run pre-commit checks
        run: |
          python -m pip install pre-commit
          pre-commit run --show-diff-on-failure --color=always --all-files

      # Run golangci-lint if enabled
      - name: golangci-lint
        uses: golangci/golangci-lint-action@v6.5.1
        with:
          version: ${{ inputs.golangci_lint_version }}